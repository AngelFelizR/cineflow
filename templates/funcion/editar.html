{% extends "base.html" %}

{% block title %}Editar Función - CineFlow{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2">
                    <i class="bi bi-pencil-square me-2"></i>Editar Función
                </h1>
                <a href="{{ url_for('funcion_lista') }}" class="btn btn-outline-warning">
                    <i class="bi bi-arrow-left me-1"></i> Volver
                </a>
            </div>

            <!-- Mensajes Flash -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Card del Formulario -->
            <div class="card dark-card">
                <div class="card-header dark-card-header">
                    <h5 class="mb-0">
                        Editando: {{ funcion.pelicula.Titulo }} - 
                        {{ funcion.FechaHora.strftime('%d/%m/%Y %H:%M') }}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('funcion_actualizar', id=funcion.Id) }}" 
                          class="needs-validation" novalidate>
                        
                        <!-- Información de Película (solo lectura) -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-film me-1"></i>Película
                            </label>
                            <div class="card border-info bg-dark">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            {% if funcion.pelicula.LinkToBanner %}
                                            <img src="{{ funcion.pelicula.LinkToBanner }}" 
                                                 alt="{{ funcion.pelicula.Titulo }}" 
                                                 class="img-fluid rounded">
                                            {% endif %}
                                        </div>
                                        <div class="col-md-9">
                                            <h5 class="text-info">{{ funcion.pelicula.Titulo }}</h5>
                                            <p class="text-light-60 mb-1">{{ funcion.pelicula.DescripcionCorta }}</p>
                                            <p class="mb-0">
                                                <span class="badge bg-secondary me-2">{{ funcion.pelicula.DuracionMinutos }} min</span>
                                                <span class="badge bg-info me-2">{{ funcion.pelicula.clasificacion.Clasificacion }}</span>
                                                <span class="badge bg-warning">{{ funcion.pelicula.idioma.Idioma }}</span>
                                            </p>
                                            <small class="text-light-60 d-block mt-2">
                                                La película no se puede cambiar. Para cambiar de película, cancela esta función y crea una nueva.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Información de Sala (solo lectura si hay boletos vendidos) -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-door-open me-1"></i>Sala
                            </label>
                            <div class="card border-warning bg-dark">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h5 class="text-warning">Sala {{ funcion.sala.NumeroDeSala }}</h5>
                                            <p class="text-light-60 mb-1">{{ funcion.sala.cine.Cine }}</p>
                                            <p class="mb-0">
                                                <span class="badge bg-info me-2">{{ funcion.sala.tipo_sala.Tipo }}</span>
                                                <span class="badge bg-secondary">{{ funcion.sala.capacidad }} asientos</span>
                                            </p>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <div class="row">
                                                <div class="col-6">
                                                    <small class="text-light-60">Adulto</small>
                                                    <div class="text-warning h5">${{ funcion.sala.tipo_sala.PrecioAdulto }}</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-light-60">Niño</small>
                                                    <div class="text-primary h5">${{ funcion.sala.tipo_sala.PrecioNino }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {% if total_boletos > 0 %}
                                    <div class="alert alert-warning mt-3">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        <small>
                                            No se puede cambiar de sala porque hay <strong>{{ total_boletos }} boleto(s)</strong> vendidos.
                                            Para cambiar de sala, cancela esta función y crea una nueva.
                                        </small>
                                    </div>
                                    {% else %}
                                    <div class="mt-3">
                                        <label for="IdSala" class="form-label small">Cambiar de Sala (solo si no hay boletos vendidos)</label>
                                        <select class="form-select" id="IdSala" name="IdSala">
                                            {% for sala in salas %}
                                            <option value="{{ sala.Id }}" 
                                                    {% if sala.Id == funcion.IdSala %}selected{% endif %}>
                                                Sala {{ sala.NumeroDeSala }} - {{ sala.cine.Cine }} 
                                                ({{ sala.tipo_sala.Tipo }}, {{ sala.capacidad }} asientos)
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Fecha y Hora -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="Fecha" class="form-label">
                                    <i class="bi bi-calendar me-1"></i>Fecha *
                                </label>
                                <input type="date" 
                                       class="form-control" 
                                       id="Fecha" 
                                       name="Fecha" 
                                       value="{{ funcion.FechaHora.strftime('%Y-%m-%d') }}"
                                       required
                                       min="{{ fecha_minima }}"
                                       max="{{ fecha_maxima }}">
                                <div class="form-text">
                                    Selecciona una fecha entre {{ fecha_minima }} y {{ fecha_maxima }}
                                </div>
                                <div class="invalid-feedback">
                                    Por favor selecciona una fecha válida.
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="Hora" class="form-label">
                                    <i class="bi bi-clock me-1"></i>Hora *
                                </label>
                                <select class="form-select" id="Hora" name="Hora" required>
                                    <option value="">Seleccionar hora...</option>
                                    {% for hora in horas_disponibles %}
                                    <option value="{{ hora }}" 
                                            {% if hora == funcion.FechaHora.strftime('%H:%M') %}selected{% endif %}>
                                        {{ hora }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    Las funciones deben comenzar en punto o media hora.
                                </div>
                                <div class="invalid-feedback">
                                    Por favor selecciona una hora.
                                </div>
                            </div>
                        </div>

                        <!-- Validación de horarios -->
                        <div id="validacionHorarios" class="mb-4">
                            <div class="alert alert-warning d-none" id="alertaSolapamiento">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                <span id="mensajeSolapamiento"></span>
                            </div>
                            <div class="alert alert-success d-none" id="confirmacionHorario">
                                <i class="bi bi-check-circle me-1"></i>
                                <span>Horario disponible. La película terminará a las <strong id="horaFin"></strong>.</span>
                            </div>
                        </div>

                        <!-- Estado -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-toggle-on me-1"></i>Estado
                            </label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="Activo" name="Activo" 
                                       {% if funcion.Activo %}checked{% endif %}
                                       {% if funcion.FechaHora <= ahora %}disabled{% endif %}>
                                <label class="form-check-label" for="Activo">
                                    Función activa
                                </label>
                            </div>
                            <div class="form-text">
                                {% if funcion.FechaHora <= ahora %}
                                Las funciones pasadas no se pueden desactivar.
                                {% else %}
                                Las funciones inactivas no aparecerán en la cartelera.
                                {% endif %}
                            </div>
                        </div>

                        <!-- Información de Boletos -->
                        {% if total_boletos > 0 %}
                        <div class="alert alert-info">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="bi bi-info-circle fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="alert-heading mb-2">Información de Boletos</h6>
                                    <p class="mb-1">Esta función tiene <strong>{{ total_boletos }} boleto(s)</strong> vendidos:</p>
                                    <ul class="mb-0 small">
                                        <li>{{ boletos_activos }} boleto(s) activos</li>
                                        <li>{{ boletos_cancelados }} boleto(s) cancelados</li>
                                        <li>{{ boletos_usados }} boleto(s) usados</li>
                                        <li>Ocupación: {{ ocupacion|round(1) }}%</li>
                                    </ul>
                                    <p class="mt-2 mb-0 small">
                                        Al cambiar la fecha/hora, los clientes serán notificados automáticamente.
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Resumen -->
                        <div class="card border-success bg-dark mb-4">
                            <div class="card-header bg-success text-dark">
                                <h6 class="mb-0"><i class="bi bi-card-checklist me-1"></i> Resumen de Cambios</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Actual:</strong></p>
                                        <ul class="list-unstyled">
                                            <li><i class="bi bi-calendar text-light-60 me-1"></i> {{ funcion.FechaHora.strftime('%d/%m/%Y') }}</li>
                                            <li><i class="bi bi-clock text-light-60 me-1"></i> {{ funcion.FechaHora.strftime('%H:%M') }}</li>
                                            <li><i class="bi bi-door-open text-light-60 me-1"></i> Sala {{ funcion.sala.NumeroDeSala }}</li>
                                            <li><i class="bi bi-building text-light-60 me-1"></i> {{ funcion.sala.cine.Cine }}</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Nuevo:</strong></p>
                                        <ul class="list-unstyled" id="resumenNuevo">
                                            <li><i class="bi bi-calendar text-light-60 me-1"></i> <span id="nuevaFecha"></span></li>
                                            <li><i class="bi bi-clock text-light-60 me-1"></i> <span id="nuevaHora"></span></li>
                                            <li><i class="bi bi-door-open text-light-60 me-1"></i> <span id="nuevaSala"></span></li>
                                            <li><i class="bi bi-building text-light-60 me-1"></i> <span id="nuevoCine"></span></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notificación a Clientes -->
                        {% if total_boletos > 0 %}
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-envelope me-1"></i>Notificación a Clientes
                            </label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="notificarClientes" name="notificar_clientes" checked>
                                <label class="form-check-label" for="notificarClientes">
                                    Notificar a los clientes sobre el cambio
                                </label>
                            </div>
                            <div class="form-text">
                                Se enviará un correo electrónico a los {{ boletos_activos }} cliente(s) con boletos activos.
                            </div>
                        </div>
                        {% endif %}

                        <!-- Botones -->
                        <div class="d-flex justify-content-between mt-4">
                            <div>
                                <a href="{{ url_for('funcion_lista') }}" class="btn btn-secondary">
                                    <i class="bi bi-x-circle me-1"></i> Cancelar
                                </a>
                                <a href="{{ url_for('funcion_detalle', id=funcion.Id) }}" 
                                   class="btn btn-info ms-2">
                                    <i class="bi bi-eye me-1"></i> Ver Detalle
                                </a>
                            </div>
                            <div>
                                <button type="submit" class="btn btn-warning" id="btnActualizar">
                                    <i class="bi bi-check-circle me-1"></i> Actualizar Función
                                </button>
                                {% if funcion.FechaHora > ahora %}
                                <a href="{{ url_for('seleccion_asientos', funcion_id=funcion.Id) }}" 
                                   class="btn btn-primary ms-2" target="_blank">
                                    <i class="bi bi-ticket me-1"></i> Ver Asientos
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación -->
<div class="modal fade" id="modalConfirmacion" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-warning">
            <div class="modal-header bg-dark text-light border-warning">
                <h5 class="modal-title">
                    <i class="bi bi-question-circle text-warning me-2"></i>
                    Confirmar Cambios
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body bg-dark text-light">
                <div class="alert alert-warning">
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="alert-heading mb-2">¿Actualizar Función?</h6>
                            <p class="mb-1">Se actualizará la función con los siguientes cambios:</p>
                            <ul class="mb-0 small" id="listaCambios"></ul>
                        </div>
                    </div>
                </div>
                
                {% if total_boletos > 0 %}
                <div class="card border-info mt-3">
                    <div class="card-header bg-info text-dark py-2">
                        <i class="bi bi-people me-1"></i>
                        Impacto en Clientes
                    </div>
                    <div class="card-body bg-dark py-3">
                        <p class="mb-0 small">
                            <strong>{{ boletos_activos }} cliente(s)</strong> serán notificados sobre el cambio.
                            Los boletos mantendrán su validez para la nueva fecha/hora.
                        </p>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer bg-dark border-warning">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i> Cancelar
                </button>
                <button type="button" class="btn btn-warning" id="btnConfirmar">
                    <i class="bi bi-check-circle me-1"></i> Sí, Actualizar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fechaInput = document.getElementById('Fecha');
    const horaSelect = document.getElementById('Hora');
    const salaSelect = document.getElementById('IdSala');
    const btnActualizar = document.getElementById('btnActualizar');
    const modalConfirmacion = new bootstrap.Modal(document.getElementById('modalConfirmacion'));
    const listaCambios = document.getElementById('listaCambios');
    const btnConfirmar = document.getElementById('btnConfirmar');
    const form = document.querySelector('form.needs-validation');
    
    // Información original de la función
    const funcionOriginal = {
        fecha: "{{ funcion.FechaHora.strftime('%Y-%m-%d') }}",
        hora: "{{ funcion.FechaHora.strftime('%H:%M') }}",
        salaId: "{{ funcion.IdSala }}",
        salaNumero: "{{ funcion.sala.NumeroDeSala }}",
        cine: "{{ funcion.sala.cine.Cine }}"
    };
    
    // Información de salas (precargada)
    const salasData = {
        {% for sala in salas %}
        {{ sala.Id }}: {
            numero: "{{ sala.NumeroDeSala }}",
            cine: "{{ sala.cine.Cine }}"
        },
        {% endfor %}
    };
    
    // Actualizar resumen cuando cambien los campos
    function actualizarResumen() {
        const nuevaFecha = fechaInput.value;
        const nuevaHora = horaSelect.value;
        const nuevaSalaId = salaSelect ? salaSelect.value : funcionOriginal.salaId;
        
        // Actualizar vista previa
        document.getElementById('nuevaFecha').textContent = nuevaFecha ? new Date(nuevaFecha).toLocaleDateString('es-ES') : 'Sin cambios';
        document.getElementById('nuevaHora').textContent = nuevaHora || 'Sin cambios';
        
        if (nuevaSalaId && nuevaSalaId !== funcionOriginal.salaId) {
            const salaData = salasData[nuevaSalaId];
            document.getElementById('nuevaSala').textContent = `Sala ${salaData.numero}`;
            document.getElementById('nuevoCine').textContent = salaData.cine;
        } else {
            document.getElementById('nuevaSala').textContent = `Sala ${funcionOriginal.salaNumero}`;
            document.getElementById('nuevoCine').textContent = funcionOriginal.cine;
        }
        
        // Verificar si hay cambios
        const hayCambios = (
            nuevaFecha !== funcionOriginal.fecha ||
            nuevaHora !== funcionOriginal.hora ||
            (salaSelect && nuevaSalaId !== funcionOriginal.salaId)
        );
        
        btnActualizar.disabled = !hayCambios;
        return hayCambios;
    }
    
    // Escuchar cambios en los campos
    fechaInput.addEventListener('change', actualizarResumen);
    horaSelect.addEventListener('change', actualizarResumen);
    if (salaSelect) {
        salaSelect.addEventListener('change', actualizarResumen);
    }
    
    // Inicializar resumen
    actualizarResumen();
    
    // Validación de formulario con confirmación
    if (form) {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            event.stopPropagation();
            
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            
            // Preparar lista de cambios para el modal
            listaCambios.innerHTML = '';
            const cambios = [];
            
            if (fechaInput.value !== funcionOriginal.fecha) {
                const fechaOriginal = new Date(funcionOriginal.fecha).toLocaleDateString('es-ES');
                const fechaNueva = new Date(fechaInput.value).toLocaleDateString('es-ES');
                cambios.push(`<li><strong>Fecha:</strong> ${fechaOriginal} → ${fechaNueva}</li>`);
            }
            
            if (horaSelect.value !== funcionOriginal.hora) {
                cambios.push(`<li><strong>Hora:</strong> ${funcionOriginal.hora} → ${horaSelect.value}</li>`);
            }
            
            if (salaSelect && salaSelect.value !== funcionOriginal.salaId) {
                const salaData = salasData[salaSelect.value];
                cambios.push(`<li><strong>Sala:</strong> ${funcionOriginal.salaNumero} → ${salaData.numero}</li>`);
                cambios.push(`<li><strong>Cine:</strong> ${funcionOriginal.cine} → ${salaData.cine}</li>`);
            }
            
            if (cambios.length === 0) {
                alert('No hay cambios para actualizar.');
                return;
            }
            
            listaCambios.innerHTML = cambios.join('');
            
            // Configurar botón de confirmación
            btnConfirmar.onclick = function() {
                form.submit();
            };
            
            modalConfirmacion.show();
        }, false);
    }
    
    // Validación de conflictos de horario (simplificada)
    function verificarConflictos() {
        // En una implementación real, aquí harías una llamada AJAX al servidor
        // para verificar que no hay conflictos con otras funciones
        return true;
    }
});
</script>
{% endblock %}